<!DOCTYPE HTML>
<html lang="fi">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="chatbot_UI_tyyli.css">
        <title>TUNIBot</title>
        <script src="https://unpkg.com/rivescript@latest/dist/rivescript.min.js"></script>
        <script
			  src="https://code.jquery.com/jquery-3.3.1.js"
			  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
			  crossorigin="anonymous">	
		</script>
    </head>
    <body>
        <div id="chatbot_frame">
            <div id="banner">
                <p id="banner_text">TUNIBot Prototype</p>
            </div>
            <div id="chatbot_contentpane" style="overflow-y:auto;">
                <table id="chat_content">

                </table>
            </div>
            <div id="textfield_frame">
                <input id="input_field" type="search" placeholder="Type your message...">
                <button id="submit_button">Submit</button>
            </div>

        </div>
        <p id="username">placeholder</p>

        <script type="text/javascript">

            var input = document.getElementById("input_field");
            input.addEventListener("keyup", function(event) {
                event.preventDefault();
                if(event.keyCode === 13) {
                    document.getElementById("submit_button").click();
                    document.getElementById("input_field").value = '';
                }
            });

            createUsername();
            bindCallback();

            function createUserChatBubble(text)
            {
                var table = document.getElementById("chat_content");
                var row = table.insertRow(-1);
                var cell = row.insertCell(0);
                var child = document.createElement("div");

                child.textContent = "You said: " + text;
                cell.appendChild(child);

            };

            function createBotChatBubble(text)
            {
                var table = document.getElementById("chat_content");
                var row = table.insertRow(-1);
                var cell = row.insertCell(0);
                var child = document.createElement("div");

                //Parsitaan paluuviestist√§ '<html><body>' ja '</html></body>' pois.
                var str = text;
                var i;
                var parsed_text = '';

                for(i = 0; i < str.length; i++)
                {
                    if(i > 11 && i < str.length - 14)
                    {
                        parsed_text += str[i];
                    }
                }

                child.textContent = "Bot says: " + parsed_text;
                cell.appendChild(child);

            };

            function bindCallback()
            {
                document.getElementById("input_field").value = '';
                var qwerty = "qwerty_ytrewq";

                $(document).ready(function()
                { 
                    $.post("http://localhost:8082/msg",
                        {
                            "query": qwerty,
                            "username": window.username
                        },
                        function(data, status)
                        {
                            //alert("Data: " + data + "\nStatus: " + status);
                            createBotChatBubble(data);
                        });

                    $("#submit_button").click(function()
                    {
                        var text_value = document.getElementById("input_field").value;
                        var user_name = document.getElementById("username").value;
                        createUserChatBubble(text_value);

                        $.post("http://localhost:8082/msg",
                        {
                            "query": text_value,
                            "username": window.username
                        },
                        function(data, status)
                        {
                            //alert("Data: " + data + "\nStatus: " + status);
                            createBotChatBubble(data);
                        });
                    });

                });
            };

            function createUsername()
            {

                var username = '';
                var number;
                var i;

                for(i = 0; i < 6; i++)
                {
                    number = Math.floor(Math.random() * 10);
                    username += number.toString();
                }
                window.username = username;

                document.getElementById("username").innerHTML = "UserID: " + username;
            };

        </script>    
    </body>
</html>
